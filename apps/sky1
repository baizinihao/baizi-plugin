import plugin from '../../../lib/plugins/plugin.js';
import { segment } from 'oicq';

const CONFIG = {
  taskApiUrl: 'http://baizihaoxiao.xin/API/sky_task.php',
  defaultData: {
    id: 5263355163706260,
    images: [
      "http://baizihaoxiao.xin/data/å…‰é‡/sky1.png",
      "http://baizihaoxiao.xin/data/å…‰é‡/sky2.png", 
      "http://baizihaoxiao.xin/data/å…‰é‡/sky3.png"
    ]
  }
};

export default class SkyTaskCard extends plugin {
  constructor() {
    super({
      name: 'å…‰é‡å›½é™…æœä»»åŠ¡å¡ç‰‡',
      dsc: 'è·å–å…‰é‡å›½é™…æœä»»åŠ¡ä¿¡æ¯å¹¶ä»¥å¡ç‰‡å½¢å¼å±•ç¤º',
      event: 'message',
      priority: 5000,
      rule: [
        {
          reg: '^#?å›½é™…æœä»»åŠ¡$',
          fnc: 'sendTaskCard'
        }
      ]
    });
    
    // æ·»åŠ åŠ è½½æ—¥å¿—
    console.log('[å…‰é‡ä»»åŠ¡å¡ç‰‡] æ’ä»¶åŠ è½½æˆåŠŸ');
  }

  async sendTaskCard(e) {
    console.log('[å…‰é‡ä»»åŠ¡å¡ç‰‡] æ”¶åˆ°æ¶ˆæ¯:', e.msg);
    console.log('[å…‰é‡ä»»åŠ¡å¡ç‰‡] æ¶ˆæ¯ç±»å‹:', e.message_type);
    console.log('[å…‰é‡ä»»åŠ¡å¡ç‰‡] ç”¨æˆ·ID:', e.user_id);
    
    try {
      // ä½¿ç”¨ç¤ºä¾‹æ•°æ®ç›´æ¥æµ‹è¯•
      const exampleData = {
        "status": "success",
        "data": {
          "id": 5263355163706260,
          "text": "#å…‰é‡å›½é™…æœ[è¶…è¯]#\nğŸ´å›½é™…æœ2.6ğŸ´\nğŸ‰æ¯æ—¥ä»»åŠ¡\nğŸ‰å­£èŠ‚èœ¡çƒ›ä½ç½®\nğŸ‰å¤§èœ¡çƒ›ä½ç½® â€‹\n\nğŸ‰ç»‡å…‰å­£å¼€å¯ï¼ï¼ˆ1.16~4.3ï¼‰\nğŸ…å‡¯æ—‹é”¦æ ‡èµ›å¼€å¯ï¼ï¼ˆ1.30~2.13ï¼‰\nè´§å¸ä½ç½®è¯¦è§http://t.cn/AXqu5alC\nä»Šæ—¥é»‘çŸ³ä½ç½®ï¼šäº‘é‡ä¸‰å¡”å›¾/é²¤é±¼æ± ï¼ˆå…·ä½“ä½ç½®å¾…è¡¥ï¼‰\n(æ—¶é—´ï¼š18:18-22:10 02:18-06:10 10:18-14:10ï¼‰\näºŒæœˆ â€‹â€‹â€‹",
          "images": [
            "http://baizihaoxiao.xin/data/å…‰é‡/sky1.png",
            "http://baizihaoxiao.xin/data/å…‰é‡/sky2.png",
            "http://baizihaoxiao.xin/data/å…‰é‡/sky3.png"
          ]
        }
      };
      
      console.log('[å…‰é‡ä»»åŠ¡å¡ç‰‡] å¼€å§‹æ„å»ºæ¶ˆæ¯');
      const cardMessage = await this.buildCardMessage(exampleData.data);
      
      console.log('[å…‰é‡ä»»åŠ¡å¡ç‰‡] å‡†å¤‡å‘é€æ¶ˆæ¯');
      await e.reply(cardMessage);
      console.log('[å…‰é‡ä»»åŠ¡å¡ç‰‡] æ¶ˆæ¯å‘é€æˆåŠŸ');
      
    } catch (err) {
      console.error('[å…‰é‡ä»»åŠ¡å¡ç‰‡] ç”Ÿæˆå¤±è´¥ï¼š', err);
      await e.reply('ç”Ÿæˆå…‰é‡å›½é™…æœä»»åŠ¡å¡ç‰‡å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•~');
    }
  }

  async buildCardMessage(data) {
    const messages = [];
    
    // ç¬¬ä¸€è¡Œï¼šIDä¿¡æ¯
    messages.push(segment.text(`id: ${data.id}`));
    
    // æ·»åŠ ä¸‰å¼ å›¾ç‰‡
    if (data.images && Array.isArray(data.images)) {
      console.log('[å…‰é‡ä»»åŠ¡å¡ç‰‡] å›¾ç‰‡æ•°é‡:', data.images.length);
      for (let i = 0; i < data.images.length; i++) {
        const imgUrl = data.images[i];
        console.log(`[å…‰é‡ä»»åŠ¡å¡ç‰‡] å›¾ç‰‡${i+1}:`, imgUrl);
        if (imgUrl && typeof imgUrl === 'string') {
          messages.push(segment.image(imgUrl));
        }
      }
    } else {
      console.log('[å…‰é‡ä»»åŠ¡å¡ç‰‡] æ²¡æœ‰æ‰¾åˆ°å›¾ç‰‡æ•°æ®');
    }
    
    return messages;
  }
}