import { segment } from 'oicq';
import { getLinkData } from '../../lib/tools.js';

export class SkyInternationalTaskPlugin extends plugin {
    constructor() {
        super({
            name: '[Ts]å…‰é‡å›½é™…æœä»»åŠ¡',
            dsc: 'å…‰é‡å›½é™…æœæ¯æ—¥ä»»åŠ¡æŸ¥è¯¢ï¼Œè½¬å‘å¡ç‰‡æ ·å¼',
            event: 'message',
            priority: 1,
            rule: [
                { reg: /^[#\/]?å›½é™…æœä»»åŠ¡$/i, fnc: 'showInternationalTask' }
            ]
        });
    }

    async showInternationalTask(e) {
        try {
            const res = await getLinkData('http://baizihaoxiao.xin/API/sky5.php', 'json');
            if (res.status !== 'success') return e.reply('å…‰é‡å›½é™…æœä»»åŠ¡æ•°æ®è·å–å¤±è´¥');
            
            const { text, time, source, images } = res.data;
            const taskText = text.replace(/\n/g, '\r').replace(/â€‹/g, '').trim();
            const msgContent = [taskText, `\rğŸ“…æ›´æ–°æ—¶é—´ï¼š${time}`, `\rğŸ“Œæ•°æ®æ¥æºï¼š${source}`];
            
            images.forEach(img => msgContent.push(segment.image(img)));

            const forwardMsg = [
                {
                    sender: { nickname: 'å…‰é‡å›½é™…æœä»»åŠ¡Bot', user_id: 2854196306 },
                    content: msgContent
                }
            ];

            const forwardCard = segment.forward(e.user_id, forwardMsg);
            return e.reply(forwardCard);
        } catch (error) {
            return e.reply('å…‰é‡å›½é™…æœä»»åŠ¡æŸ¥è¯¢å¼‚å¸¸ï¼Œè¯·ç¨åå†è¯•');
        }
    }
}